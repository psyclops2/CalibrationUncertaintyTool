# 不確かさ計算支援ソフト

## 概要
このソフトは、測定値の不確かさを計算するためのGUIアプリケーションです。

JCGM 100（Guide to the Expression of Uncertainty in Measurement）GUMの方法に基づいて不確かさを計算します。

モンテカルロ法による分布伝播を実装しており、「モンテカルロ」タブでヒストグラム表示・正規分布曲線との比較・区間比較ができます。

測定の数学的モデル式から不確かさの伝播則の式を導き、各量に対しその量の値を与え不確かさを計算、バジェットシートを出力します。

同一モデル式に従う複数の校正点についての校正の不確かさの計算を一括で行えるようにしています。

## 主な機能
1. モデル方程式の入力と量の管理
2. 測定値と不確かさの入力
3. 感度係数の自動計算
4. 不確かさの伝播則の式の自動計算
5. バジェットシートの表示とエクスポート
6. 回帰分析（モデル管理、CSV取込、逆推定）
7. モンテカルロシミュレーション（結果変数の分布可視化、95%区間比較）

## システム要件
- Python 3.8以上
- PySide6 (LGPLv3ライセンス)
- NumPy (BSDライセンス)
- SymPy (BSDライセンス)
- Markdown (BSDライセンス)

## インストール方法
1. リポジトリをクローン
```bash
git clone [repository-url]
```

2. 依存パッケージのインストール
```bash
pip install -r requirements.txt
```

3. アプリケーションの起動
```bash
python src/main.py
```

## 設定ファイル（config.ini）

アプリの設定はリポジトリ直下の [`config.ini`](./config.ini) に保存されています。主な項目は次のとおりです。

* **[Calculation]**
  * `precision`: 計算結果に使用する小数精度。
* **[Defaults]**
  * `value_count`: 各量に初期作成される値（校正点）の個数。
  * `current_value_index`: 量の編集時に最初に選択される値のインデックス。
* **[CalibrationPoints]**
  * `min_count`, `max_count`: UI 上で設定できる校正点数の最小値と最大値。
* **[UncertaintyRounding]**
  * `significant_digits`: 不確かさ値の表示に用いる有効数字。
  * `rounding_mode`: 丸め方法（`round_up` または `5_percent`）。
* **[Language]**
  * `current`: UI の言語（`ja` または `en`）。
  * `use_system_locale`: 設定言語よりシステムロケールを優先するかどうか。
* **[Messages]**
  * `equation_change`: モデル式変更時に変数更新が必要な場合のメッセージテンプレート。
* **[Distribution]**
  * `normal_distribution`, `rectangular_distribution`, `triangular_distribution`, `u_distribution`: 各分布で区間値から標準不確かさへ変換する際の除数。
* **[TValues]**
  * 自由度に応じた包含係数のルックアップ（無限大は `infinity` を使用）。
* **[Version]**
  * `version`: UI やレポートで表示するバージョン文字列。

## プロジェクト構造
```
src/
├── __main__.py         # メインエントリーポイント
├── main.py             # メインアプリケーション
├── main_window.py      # メインウィンドウの実装
├── dialogs/           # ダイアログウィンドウの実装
├── models/            # データモデルの実装
├── tabs/              # タブ関連のモジュール
├── utils/             # ユーティリティモジュール
└── widgets/           # カスタムウィジェットの実装
```

詳細なファイル構成については、各ディレクトリ内のファイルを参照してください。

## 計算の背景と根拠

### 1. 不確かさの伝播則
GUMに基づき、以下の不確かさの伝播則の式を使用して計算を行います：

相関のある入力量についても、**相関係数**タブで相関係数行列 `r(xᵢ, xⱼ)` を入力することで計算できます（対角は 1、既定では非対角は 0）。
共分散項は次の関係で取り扱います：

`u(xᵢ, xⱼ) = u(xᵢ) u(xⱼ) r(xᵢ, xⱼ)`

```
u²(y) = Σ(∂f/∂xᵢ)²u²(xᵢ) + 2ΣΣ(∂f/∂xᵢ)(∂f/∂xⱼ)u(xᵢ,xⱼ)
```

ここで：
- u(y): 計算結果の不確かさ
- ∂f/∂xᵢ: 感度係数
- u(xᵢ), u(xⱼ): 入力変数の不確かさ
- u(xᵢ,xⱼ): 共分散（相関不確かさ）

### 2. 感度係数の計算
感度係数は、モデル方程式の各入力変数に関する偏微分として計算されます：

```
∂f/∂xᵢ = lim(Δxᵢ→0) [f(x₁,...,xᵢ+Δxᵢ,...,xₙ) - f(x₁,...,xᵢ,...,xₙ)] / Δxᵢ
```

#### 連立方程式の場合
連立方程式の場合は、連鎖律（chain rule）を使用して感度係数を計算します：

次の例を考えてみます。
```
W = V × I
V = V_MEAS + V_CAL
I = I_MEAS + I_CAL
```
ここで、I_CAL に対する W の感度係数（偏微分）を求めたい場合、チェーンルールを使うと次のように書けます。
```
∂W/∂I_CAL = (∂W/∂V)(∂V/∂I_CAL) + (∂W/∂I)(∂I/∂I_CAL)
```
```
W = V × I より
∂W/∂V = I
∂W/∂I = V
```
V は I_CAL に依存しない（V = V_MEAS + V_CAL に I_CAL が入っていない）ので、
```
∂V/∂I_CAL = 0
```
```
I = I_MEAS + I_CAL なので、
∂I/∂I_CAL = 1
```
上記を代入すると、
```
∂W/∂I_CAL = I × 0 + V × 1 = V
```
### 3. 不確かさの種類
#### A Type不確かさ（統計的手法による評価）

繰り返し測定に基づいて統計的に評価される不確かさです。

現在は最も基本的な方法（単一系列の測定値に基づく評価）のみに対応しています。

1. 標準不確かさ（平均値の実験標準偏差）
繰り返し測定値が x1, x2, ..., xn のとき、平均値 x̄ に対する標準不確かさ u は以下の式で求めます。

繰り返し測定の結果はカンマ(,)で区切り入力します。
```
u = sqrt( (1 / (n * (n - 1))) * Σ(xi - x̄)^2 )
```
2. 自由度
自由度 ν は以下の式で求めます。
```
ν = n - 1
```
#### B Type不確かさ（統計的手法以外による評価）

試験成績書、仕様書、技術文書、過去の経験など、統計的データに依らない情報から評価される不確かさです。

以下の分布に基づく評価方法に対応しています。

1. 矩形分布（均等分布）
```
u = a / sqrt(3)
```
2. 三角分布
```
u = a / sqrt(6)
```

3. 正規分布
```
u = a / k
```
a は信頼限界、k は信頼係数。例：95%信頼水準なら k ≒ 2

証明書の値を利用する場合、a は拡張不確かさ、k は包含係数

それぞれの有効自由度は任意の値を設定できますが、NITEの指針ではType Bは ∞ を当てるのが一般的です。

数値を入力しなければ ∞ して扱われます。

### 4. 自由度の計算
Welch-Satterthwaiteの式を使用して有効自由度を計算：

Type Bの不確かさで自由度が入力されていない場合、自由度は∞として扱われます。
```
νeff = u⁴(y) / Σ[u⁴(xᵢ) / νᵢ]
```

### 5. 拡張不確かさの計算
包含係数k（通常k=2）を使用して拡張不確かさを計算します。

```
U = k * u(y)
```
包含係数 k は、t 分布表の 95 t (νeff)の値として計算しますが、

単純のため下記の表を参照し割り当てます。
| νeff | 1    | 2    | 3    | 4    | 5    | 6    | 7    | 8    | 9    | 10   | 20   | 50   | ∽   |
|------|------|------|------|------|------|------|------|------|------|------|------|------|------|
| k    | 12.71| 4.30 | 3.18 | 2.78 | 2.57 | 2.45 | 2.36 | 2.31 | 2.26 | 2.23 | 2.09 | 2.01 | 1.96 |

運用上は、νeff が 10 以上の場合は包含係数を 2 として扱います。


## 使用方法
1. モデル式の入力タブ
   - モデル式を入力（例：W = V * I / R）

   ^で乗数、_で添字を表すことが出来ます。

   式の左辺は計算結果の量として扱われます。

   これは他に登録された量の値から計算により求まる量の値で、直接値を入力しません。

   このため2.で示す量の値や不確かさタイプの指定等は行えません。
   - モデル式から式に含まれる量の値が自動で切り出されます。
   - 複数の方程式はカンマで区切って入力可能です。カンマのあとに改行を入れてもOKです。
   - 量のリストで表示されている量をドラッグドロップすることでバジェットシートに表示する順番を指定できます。

2. 校正点設定
   - 校正点名の設定、校正点の追加・削除を行います。

3. 量の設定
   - 各量の値を入力
   - 校正点の数を変更することで各量に校正点の数だけ値をもたせることが出来ます。
   - 各量に不確かさの種類や単位、定義の説明をもたせられます。

4. 相関係数
   - 入力量どうしに相関がある場合、相関係数行列 `r(xᵢ, xⱼ)` を入力します。
   - 対角成分は `1.0` 固定、既定では非対角成分は `0.0`（独立）です。

5. 偏微分
   - モデル式から各変数の偏微分を算出し、結果を確認できます。

6. 計算の実行
   - 不確かさ計算タブでは任意の校正値、１つの校正点における不確かさバジェットを作成します。

7. 回帰
   - 回帰モデルの追加・複製・削除、説明と x/y 単位の設定ができます。
   - `x`, `u(x)`, `y` を表形式で入力し、行の追加・削除ができます。
   - CSV テキストを貼り付けてインポートできます（`x, u(x), y` または `x, y` 形式。2点以上必須）。
   - 計算結果（切片、傾き、Significance F、残差分散、平均値、不確かさ項）を確認できます。
   - 逆推定：`y0` を入力すると `x0` と `u(x0)` を計算し、行の追加・削除ができます。
   - 計算式は以下を使用します。

```
線形モデル: y = βx + α
平均値: x̄ = (1/n) Σ xᵢ, ȳ = (1/n) Σ yᵢ
Sxx = Σ (xᵢ - x̄)²
β = Σ[(xᵢ - x̄)(yᵢ - ȳ)] / Sxx
α = ȳ - β x̄
残差: rᵢ = yᵢ - (β xᵢ + α)
残差分散: s² = Σ rᵢ² / (n - 2)  (n ≥ 3), s = √s²
Significance F: SSR = Σ(ŷᵢ - ȳ)², SSE = Σ rᵢ², MSE = SSE/(n-2), F = SSR/MSE
u(β) = √(s² / Sxx)
ūx = (1/n) Σ u(xᵢ)
ūy = √(s² / n)
逆推定: x₀ = (y₀ - ȳ)/β + x̄
u(x₀) = √( ūy²/β² + (y₀ - ȳ)² u(β)² / β⁴ + ūx² )
```

8. 文書情報
   - 文書情報タブで文書番号、文書名、版数、説明（Markdown対応）を記録できます。
   - 改訂履歴はCSV形式（版数、改訂内容、作成者、確認者、承認者、日付）で入力し、レポートへ反映できます。

9. レポート
   - 不確かさ計算タブでは任意の1点についてバジェットを作成しましたが、

    このレポート機能では任意の計算量のすべての校正点のバジェットを一括で表示します。
    -この結果はHTMLファイルとして出力保存ができます。
   - 表示のスタイルはCSSでカスタマイズできます。`css/default.css` が標準で適用され、`css/custom.css` を編集すると上書きできます（レポート作成のたびにCSSを読み直します）。出力したHTMLにもCSSは埋め込まれます。

## 注意事項
- 数値の表示は `config.ini` の `UncertaintyRounding` 設定に従って丸め、指数は 3 の倍数で表記します。
- 内部計算は `config.ini` の `[Calculation]` に設定された精度の `Decimal` を使用します。
- 入力量どうしに相関がある場合は、相関係数タブで相関係数を入力してください（既定では非対角は 0 です）。

例えば、電圧Vと電流Iを測定して抵抗Rを求めるモデル式（R = V/I）では、数式上 V と I は互いに依存しており、繰り返し測定においても V が変動すれば I も変動します。

このため、V と I の測定結果には統計的な相関が生じることになります。

相関が無視できない場合、相関係数を入力しないと不確かさが過小/過大評価される可能性があります。

## ライセンス / License

このソフトウェアは **MIT License** の下で公開されています。
自由に使用、複製、変更、再配布することができますが、必ず元の著作権表示およびライセンス文を含めてください。
詳細な条件については同梱の [`LICENSE`](./LICENSE) ファイルをご覧ください。

### 使用している外部ライブラリとライセンス / Third-Party Libraries and Licenses

本ソフトウェアは以下の外部ライブラリに依存しています（いずれも配布物には含まれません。利用者側で `pip` などによりインストールが必要です）：

| ライブラリ / Library | ライセンス / License          | URL                                                                                                     |
| --------------- | ------------------------ | ------------------------------------------------------------------------------------------------------- |
| PySide6         | LGPLv3（© The Qt Company） | [Qt for Python](https://www.qt.io/qt-for-python) / [LGPLv3](https://www.gnu.org/licenses/lgpl-3.0.html) |
| NumPy           | BSD 3-Clause             | [NumPy](https://numpy.org/) / [BSD License](https://opensource.org/licenses/BSD-3-Clause)               |
| SymPy           | BSD 3-Clause             | [SymPy](https://www.sympy.org/) / [BSD License](https://opensource.org/licenses/BSD-3-Clause)           |
| Markdown (Python-Markdown) | BSD 3-Clause | [Python-Markdown](https://python-markdown.github.io/) / [BSD License](https://opensource.org/licenses/BSD-3-Clause) |

Python 標準ライブラリ（json, decimal, re, math, traceback）は [Python Software Foundation License](https://docs.python.org/3/license.html) に従います。

各ライブラリの詳細なライセンス内容については、公式サイトや PyPI ページをご確認ください。
