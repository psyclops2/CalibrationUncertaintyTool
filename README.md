# 不確かさ計算支援ソフト

## 概要
このソフトは、測定値の不確かさを計算するためのGUIアプリケーションです。

JCGM 100（Guide to the Expression of Uncertainty in Measurement）GUMの方法に基づいて不確かさを計算します。

モンテカルロ法による分布の伝播の計算は未実装です。

測定の数学的モデル式から不確かさの伝播則の式を導き、各量に対しその量の値を与え不確かさを計算、バジェットシートを出力します。

同一モデル式に従う複数の校正点についての校正の不確かさの計算を一括で行えるようにしています。

## 主な機能
1. モデル方程式の入力と量の管理
2. 測定値と不確かさの入力
3. 感度係数の自動計算
4. 不確かさの伝播則の式の自動計算
5. バジェットシートの表示とエクスポート

## システム要件
- Python 3.8以上
- PyQt5 (GPLv3ライセンス)
- NumPy (BSDライセンス)
- SymPy (BSDライセンス)

## インストール方法
1. リポジトリをクローン
```bash
git clone [repository-url]
```

2. 依存パッケージのインストール
```bash
pip install -r requirements.txt
```

3. アプリケーションの起動
```bash
python src/main.py
```

## プロジェクト構造
```
src/
├── main.py              # メインアプリケーション
├── tabs/               # タブ関連のモジュール
│   ├── model_equation_tab.py    # モデル方程式入力タブ
│   ├── uncertainty_calculation_tab.py  # 不確かさ計算タブ
│   └── variables_tab.py        # 変数管理タブ
└── utils/              # ユーティリティモジュール
    └── equation_formatter.py   # 数式フォーマッター
```

## 計算の背景と根拠

### 1. 不確かさの伝播則
GUMに基づき、以下の不確かさの伝播則の式を使用して計算を行います：

ただし現時点では2項目の相関不確かさについての計算は実装していません。

モデル式の時点で相関がないよう考慮してください。

```
u²(y) = Σ(∂f/∂xᵢ)²u²(xᵢ) + 2ΣΣ(∂f/∂xᵢ)(∂f/∂xⱼ)u(xᵢ,xⱼ)
```

ここで：
- u(y): 計算結果の不確かさ
- ∂f/∂xᵢ: 感度係数
- u(xᵢ): 入力変数の不確かさ
- u(xᵢ,xⱼ): 相関不確かさ

### 2. 感度係数の計算
感度係数は、モデル方程式の各入力変数に関する偏微分として計算されます：

```
∂f/∂xᵢ = lim(Δxᵢ→0) [f(x₁,...,xᵢ+Δxᵢ,...,xₙ) - f(x₁,...,xᵢ,...,xₙ)] / Δxᵢ
```

#### 連立方程式の場合
連立方程式の場合は、連鎖律（chain rule）を使用して感度係数を計算します：

次の例を考えてみます。
```
W = V × I
V = V_MEAS + V_CAL
I = I_MEAS + I_CAL
```
ここで、I_CAL に対する W の感度係数（偏微分）を求めたい場合、チェーンルールを使うと次のように書けます。
```
∂W/∂I_CAL = (∂W/∂V)(∂V/∂I_CAL) + (∂W/∂I)(∂I/∂I_CAL)
```
```
W = V × I より
∂W/∂V = I
∂W/∂I = V
```
V は I_CAL に依存しない（V = V_MEAS + V_CAL に I_CAL が入っていない）ので、
```
∂V/∂I_CAL = 0
```
```
I = I_MEAS + I_CAL なので、
∂I/∂I_CAL = 1
```
上記を代入すると、
```
∂W/∂I_CAL = I × 0 + V × 1 = V
```
### 3. 不確かさの種類
#### A Type不確かさ（統計的手法による評価）

繰り返し測定に基づいて統計的に評価される不確かさです。

現在は最も基本的な方法（単一系列の測定値に基づく評価）のみに対応しています。

1. 標準不確かさ（平均値の実験標準偏差）
繰り返し測定値が x1, x2, ..., xn のとき、平均値 x̄ に対する標準不確かさ u は以下の式で求めます。

繰り返し測定の結果はカンマ(,)で区切り入力します。
```
u = sqrt( (1 / (n * (n - 1))) * Σ(xi - x̄)^2 )
```
2. 自由度
自由度 ν は以下の式で求めます。
```
ν = n - 1
```
#### B Type不確かさ（統計的手法以外による評価）

試験成績書、仕様書、技術文書、過去の経験など、統計的データに依らない情報から評価される不確かさです。

以下の分布に基づく評価方法に対応しています。

1. 矩形分布（均等分布）
```
u = a / sqrt(3)
```
2. 三角分布
```
u = a / sqrt(6)
```

3. 正規分布
```
u = a / k
```
a は信頼限界、k は信頼係数。例：95%信頼水準なら k ≒ 2

証明書の値を利用する場合、a は拡張不確かさ、k は包含係数

それぞれの有効自由度は任意の値を設定できますが、NITEの指針ではType Bは ∞ を当てるのが一般的です。

数値を入力しなければ ∞ して扱われます。

### 4. 自由度の計算
Welch-Satterthwaiteの式を使用して有効自由度を計算：

Type Bの不確かさで自由度が入力されていない場合、自由度は∞として扱われます。
```
νeff = u⁴(y) / Σ[u⁴(xᵢ) / νᵢ]
```

### 5. 拡張不確かさの計算
包含係数k（通常k=2）を使用して拡張不確かさを計算します。

```
U = k * u(y)
```
包含係数 k は、t 分布表の 95 t (νeff)の値として計算しますが、

単純のため下記の表を参照し割り当てます。
| νeff | 1    | 2    | 3    | 4    | 5    | 6    | 7    | 8    | 9    | 10   | 20   | 50   | ∽   |
|------|------|------|------|------|------|------|------|------|------|------|------|------|------|
| k    | 12.71| 4.30 | 3.18 | 2.78 | 2.57 | 2.45 | 2.36 | 2.31 | 2.26 | 2.23 | 2.09 | 2.01 | 1.96 |


## 使用方法
1. モデル式の入力タブ
   - モデル式を入力（例：W = V * I / R）

   ^で乗数、_で添字を表すことが出来ます。

   式の左辺は計算結果の量として扱われます。

   これは他に登録された量の値から計算により求まる量の値で、直接値を入力しません。

   このため2.で示す量の値や不確かさタイプの指定等は行えません。
   - モデル式から式に含まれる量の値が自動で切り出されます。
   - 複数の方程式はカンマで区切って入力可能です。カンマのあとに改行を入れてもOKです。
   - 量のリストで表示されている量をドラッグドロップすることでバジェットシートに表示する順番を指定できます。

2. 量の設定
   - 各量の値を入力
   - 校正点の数を変更することで各量に校正点の数だけ値をもたせることが出来ます。
   - 各量に不確かさの種類や単位、定義の説明をもたせられます。

3. 計算の実行
   - 不確かさ計算タブでは任意の校正値、１つの校正点における不確かさバジェットを作成します。

4. レポート
   - 不確かさ計算タブでは任意の1点についてバジェットを作成しましたが、

   このレポート機能では任意の計算量のすべての校正点のバジェットを一括で表示します。
   -この結果はHTMLファイルとして出力保存ができます。

## 注意事項
- 数値の表示にあたっては内部で有効数字9桁と3の倍数の指数で丸めが行われています。
- 内部計算では丸めは使用しておらずfloatで値を持っています。
- モデル式は、各量の不確かさが独立（相関がない）とみなせるように構成してください。

例えば、電圧Vと電流Iを測定して抵抗Rを求めるモデル式（R = V/I）では、数式上 V と I は互いに依存しており、繰り返し測定においても V が変動すれば I も変動します。

このため、V と I の測定結果には統計的な相関が生じることになります。

本ソフトでは、現時点では相関不確かさ（共分散項）の計算に対応していないため、入力するモデル式は、相関が無視できるよう配慮されたものを推奨します。

## ライセンス

このソフトウェアは GNU General Public License version 3（GPLv3）の下で公開されています。

自由に使用、複製、変更、再配布することができますが、再配布する際は **同じGPLv3ライセンス**で行う必要があります。  

詳細なライセンス条件については、同梱の `LICENSE` ファイルをご覧ください。

### 使用している外部ライブラリとライセンス

本ソフトウェアは以下の外部ライブラリに依存しています（いずれも再配布は行っていません）：

| ライブラリ | ライセンス | 備考 |
|------------|------------|------|
| PyQt5      | GPLv3       | 利用者にて別途インストールが必要です |
| NumPy      | BSD（3条項）| pip により自動インストールされます |
| SymPy      | BSD（3条項）| 同上 |

各ライブラリのライセンスについては、各プロジェクトの公式サイトまたは PyPI ページをご参照ください。

各ライブラリのライセンス条文および著作権表示は `third_party_licenses/` ディレクトリにあります。
